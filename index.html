<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->

    <link rel="stylesheet" href="css/spectre.min.css" />

    <style type="text/css">
      .filterinvisible {
        visibility: hidden;
      }
    </style>

    <title>flatmark</title>
  </head>
<body>
  <div class="container grid-960">
    <div class="columns">
      <div class="column col-12">
        <h1>flatmark <small>v0.1.0</small></h1>
        <p>by <a href="https://philcoffeejunkie.github.io" target="_blank" rel="noopener">philcoffeejunkie</a></p>
        <div class="input-group">
          <input class="form-input" id="markinput" type="text" />
          <button class="btn btn-primary input-group-btn">Submit</button>
        </div>
        <p id="marks"></p>
        <p><a href="#" onclick="resetFilter()">Reset Filter</a></p>
      </div>
    </div>
  </div>

  <!-- jQuery -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>

  <script>
  function deleteBookmark(bookmarkID) {
    $.ajax({
      type: "GET",
      url: "flatmark.php?action=del&id=" + bookmarkID,
      success: function(data) {
        alert('del ' + bookmarkID);
        $("span").remove("#" + bookmarkID);
      }
    });
  }

  function containsDescription(bookmarkString) {
    if ((bookmarkString.indexOf('(') != -1) && (bookmarkString.indexOf(')') != -1)) {
      return true;
    }
    else {
      return false;
    }
  }

  function containsTags(bookmarkString) {
    if (bookmarkString.indexOf('#') != -1) {
      return true;
    }
    else {
      return false;
    }
  }

  function getBookmarkLink(bookmarkString) {
    spacePosition = bookmarkString.indexOf(' ');
    if (spacePosition != -1) {
      return bookmarkString.substring(0, spacePosition);
    }
    else {
      return bookmarkString;
    }
  }

  function getBookmarkDescription(bookmarkString) {
    var startPos = 0;
    var endPos = 0;
    startPos = bookmarkString.indexOf('(') + 1;
    endPos = bookmarkString.indexOf(')') - 1;
    return bookmarkString.substring(startPos, endPos);
  }

  function getBookmarkTags(bookmarkString) {
    var allTags = [];
    var startPos = 0;
    startPos = bookmarkString.indexOf('#');
    allTags = bookmarkString.substring(startPos, bookmarkString.length);
    return allTags.split(' ');
  }

  function handleBookmarkString(bookmarkString, bookmarkID) {
    var bookmarkLink = '';
    var bookmarkDescription = '';
    var bookmarkHTML = '';
    var index;

    bookmarkLink = getBookmarkLink(bookmarkString);
    bookmarkHTML = '<span id="'+ bookmarkID + '"><a href="#" onClick="deleteBookmark(' + bookmarkID + ');">del</a> ';
    bookmarkHTML = bookmarkHTML + '<a href="' + bookmarkLink + '" target="_blank" rel="noopener">' + bookmarkLink + '</a>';

    if (containsDescription(bookmarkString)) {
      bookmarkDescription = getBookmarkDescription(bookmarkLink);
      bookmarkHTML = bookmarkHTML + bookmarkDescription;
    }

    if (containsTags(bookmarkString)) {
      tagArray = getBookmarkTags(bookmarkString);
      for (index = 0; index < tagArray.length; ++index) {
        bookmarkHTML = bookmarkHTML + ' ' + tagArray[index];
      }
    }

    // append bookmarkHTML to DOM
    $('#marks').append(bookmarkHTML + '</span><br>');
  }

  function handleBookmarkList(bookmarkList) {
    var bookmarkStringList = [];
    var bookmarkID = 0;
    var index;

    bookmarkStringList = bookmarkList.trim().split('\n');

    for (index = 0; index < bookmarkStringList.length; ++index) {
      handleBookmarkString(bookmarkStringList[index], bookmarkID);
      bookmarkID++;
    }
  }

  function resetFilter() {
    $(".filterinvisible").each(function() {
      $(this).removeClass("filterinvisible");
    });
  }


  // ****** MAIN PROGRAM ****** //
  $(document).ready(function() {
    $.ajax({
        type: "GET",
        url: "flatmark.php?action=init",
        success: function(data) {
          handleBookmarkList(data);
        }
    });
  });

  // ****** HANDLE INPUT ****** //

  $("#markinput").keypress(function(event) {
    if (event.which == 1) {
      event.preventDefault();
    }

    if (event.key == 'Enter') {
      var bookmark_to_save = {};
      bookmark_to_save['text'] = $("#markinput").val();

      // filter or add?
      if (bookmark_to_save['text'].startsWith("http")) {
        // ajax call
        $.ajax({
          type: "POST",
          url: "flatmark.php?action=addmark",
          data: bookmark_to_save,
          success: function(html) {
            alert('Bookmark erfolgreich gespeichert!'); // TODO: better modal
            $("#markinput").val('');
            handleBookmarkString(bookmark_to_save['text'], 0);
          }
        });
      }
      else {
        // alert("filter!");
        $("span").each(function() {
          //Or: $.each( $("p"), function() {

          var tags = getBookmarkTags(bookmark_to_save['text']);
          var index;
          console.log(tags);

          for (index = 0; index < tags.length; ++index) {
            if ($(this).html().indexOf(tags[index]) == -1) {
              console.log(tags[index]);
              console.log($(this).html());
              $(this).addClass("filterinvisible");
            }
          }
        });
      }
    }
  });
  </script>

</body>
</html>
