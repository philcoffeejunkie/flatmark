<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>flatmark</title>
  </head>
<body>
  <h1>flatmark</h1>

  <input id="markinput" type="text" />

  <p id="marks"></p>

  <!-- jQuery -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>

  <script>
  function deleteBookmark(bookmarkID) {
    $.ajax({
      type: "GET",
      url: "flatmark.php?action=del&id=" + bookmarkID,
      success: function(data) {
        alert('del ' + bookmarkID);
      }
    });
  }

  function containsDescription(bookmarkString) {
    if ((bookmarkString.indexOf('(') != -1) && (bookmarkString.indexOf(')') != -1)) {
      return true;
    }
    else {
      return false;
    }
  }

  function containsTags(bookmarkString) {
    if (bookmarkString.indexOf('#') != -1) {
      return true;
    }
    else {
      return false;
    }
  }

  function getBookmarkLink(bookmarkString) {
    spacePosition = bookmarkString.indexOf(' ');
    if (spacePosition != -1) {
      return bookmarkString.substring(0, spacePosition);
    }
    else {
      return bookmarkString;
    }
  }

  function getBookmarkDescription(bookmarkString) {
    var startPos = 0;
    var endPos = 0;
    startPos = bookmarkString.indexOf('(') + 1;
    endPos = bookmarkString.indexOf(')') - 1;
    return bookmarkString.substring(startPos, endPos);
  }

  function getBookmarkTags(bookmarkString) {
    var allTags = [];
    var startPos = 0;
    startPos = bookmarkString.indexOf('#');
    allTags = bookmarkString.substring(startPos, bookmarkString.length);
    return allTags.split(' ');
  }

  function handleBookmarkString(bookmarkString, bookmarkID) {
    var bookmarkLink = '';
    var bookmarkDescription = '';
    var bookmarkHTML = '';
    var index;

    bookmarkLink = getBookmarkLink(bookmarkString);
    bookmarkHTML = '<a href="#" onClick="deleteBookmark(' + bookmarkID + ');">del</a> ';
    bookmarkHTML = bookmarkHTML + '<a href="' + bookmarkLink + '">' + bookmarkLink + '</a>';

    if (containsDescription(bookmarkString)) {
      bookmarkDescription = getBookmarkDescription(bookmarkLink);
      bookmarkHTML = bookmarkHTML + bookmarkDescription;
    }

    if (containsTags(bookmarkString)) {
      tagArray = getBookmarkTags(bookmarkString);
      for (index = 0; index < tagArray.length; ++index) {
        bookmarkHTML = bookmarkHTML + ' ' + tagArray[index];
      }
    }

    // append bookmarkHTML to DOM
    $('#marks').append(bookmarkHTML + '<br>');
  }

  function handleBookmarkList(bookmarkList) {
    var bookmarkStringList = [];
    var bookmarkID = 0;
    var index;

    bookmarkStringList = bookmarkList.trim().split('\n');

    for (index = 0; index < bookmarkStringList.length; ++index) {
      handleBookmarkString(bookmarkStringList[index], bookmarkID);
      bookmarkID++;
    }
  }


  // ****** MAIN PROGRAM ****** //
  $(document).ready(function() {
    $.ajax({
        type: "GET",
        url: "flatmark.php?action=init",
        success: function(data) {
          handleBookmarkList(data);
        }
    });
  });

  // ****** HANDLE INPUT ****** //

  $("#markinput").keypress(function(event) {
    if (event.which == 1) {
      event.preventDefault();
    }

    if (event.key == 'Enter') {
      var bookmark_to_save = {};
      bookmark_to_save['text'] = $("#markinput").val();

      // ajax call
      $.ajax({
        type: "POST",
        url: "flatmark.php?action=addmark",
        data: bookmark_to_save,
        success: function(html) {
          alert('Bookmark erfolgreich gespeichert!'); // TODO: better modal
          handleBookmarkString(bookmark_to_save['text'], 0);
        }
      });
    }
  });
  </script>

</body>
</html>
